package vm

import (
	"context"
	"fmt"
	"cloudy-azure/models"
	"cloudy-azure/logging"
	"cloudy-azure/powershell"
	"cloudy-azure/storage"
)

func (vmm *AzureVirtualMachineManager) ExecuteSetupPowershell(ctx context.Context, vm *models.VirtualMachine) (*models.VirtualMachine, error) {
	log := logging.GetLogger(ctx)
	log.DebugContext(ctx, "virtualMachineSetup started")

	// TODO: generate SAS URL
	// perms := sas.ContainerPermissions{Read: true, List: true}
	// validFor := 1*time.Hour
	
	// storageAccountName := avd.config.StorageAccountName
	// containerName := avd.config.ContainerName

	// sasURL, err := storage.GenerateUserDelegationSAS(ctx, avd.credentials, storageAccountName, containerName, validFor, perms)
	// if err != nil {
	// 	return nil, fmt.Errorf("failed to generate SAS token: %w", err)
	// }
	// log.DebugContext(ctx, "Generated SAS token",
	// 	"storageAccount", storageAccountName,
	// 	"container", containerName,
	// 	"validFor", fmt.Sprintf("%d days %d hours %d minutes", int(validFor.Hours()/24), int(validFor.Hours())%24, int(validFor.Minutes())%60),
	// 	"permissions", perms)

	// VM create complete, begin VM setup
	powershellConfig := powershell.PowershellConfig{
		ADJoin: &powershell.ADJoinConfig{
			DomainName: "",
		},


		// EnableADJoin: true,  // TODO: Handle AD join disable
		// EnableAVDInstall: true,
		// EnableSaltInstall: true,  // TODO: Handle salt install disable
		RestartVirtualMachine: true,  // TODO: Handle VM restart disable
	}

	if AzureVirtualDesktopManager == nil {
		// AVD Disabled via config
		powershellConfig.EnableAVDInstall = false
		script := powershell.BuildVirtualMachineSetupScript(powershellConfig)
	
		err := VirtualMachineManager.RunPowershell(ctx, vm.ID, script)
		if err != nil {
			return nil, cloudylogging.LogAndWrapErr(ctx, log, err, "Could not run powershell (AVD disabled)")
	
		}

	} else {
		// AVD Enabled
		hostPoolNamePtr, hostPoolTokenPtr, err := AzureVirtualDesktopManager.PreRegister(ctx, vm)
		powershellConfig.RegistrationToken = *hostPoolTokenPtr
		if err != nil {
			return nil, cloudylogging.LogAndWrapErr(ctx, log, err, "AVD Pre-Register failed")
		}

		script := powershell.BuildVirtualMachineSetupScript(powershellConfig)
	
		err = VirtualMachineManager.RunPowershell(ctx, vm.ID, script)
		if err != nil {
			return nil, cloudylogging.LogAndWrapErr(ctx, log, err, "Could not run powershell (AVD enabled)")
		}
	
		vm, err = AzureVirtualDesktopManager.PostRegister(ctx, vm, *hostPoolNamePtr)
		if err != nil {
			return nil, cloudylogging.LogAndWrapErr(ctx, log, err, "AVD Post-Register VM")
		}
	}

	return vm, nil
}

// getOptionalConfig retrieves the config value. If the value is nil or empty, it returns the fallback value.
func getOptionalConfig(ctx context.Context, configValue *string, fallbackValue string) string {
	log := logging.GetLogger(ctx)

	// If the actual config value is present and non-empty, return it.
	if configValue != nil && *configValue != "" {
		log.DebugContext(ctx, fmt.Sprintf("Returning provided config value '%s'.", *configValue))
		return *configValue
	}

	// Otherwise, check if we have a valid fallback.
	log.DebugContext(ctx, fmt.Sprintf("config value not provided; using fallback value '%s'.", fallbackValue))
	return fallbackValue
}